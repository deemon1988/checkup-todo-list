{% load humanize %}

{% if baskets %}
<h4 class="mt-3 mb-3 d-flex justify-content-between align-items-center mb-3">
                Корзина <span class="badge badge-secondary badge-pill">{{baskets.total_quantity}}</span>
            </h4>
{% for basket in baskets %}
 <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{basket.product.name}}</h5>
                    <p class="card-text">{{basket.product.description}}</p>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-light">
                        <div class="row text-center">
                            <div class="col-lg-4">
                                <input name="basketID" type="number" class="form-control quantity-input"
       data-id="{{ basket.id }}" value="{{ basket.quantity }}" min="1">
                            </div>
                            <div class="col-lg-4 basket-sum" id="basket-sum-{{ basket.id }}">
    {{ basket.sum|intcomma }} руб.
</div>
                            <div class="col-lg-4">
                                <a href="{% url 'products:basket_remove' basket.id %}">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
{% endfor %}

            <div class="card mb-3">
                <div class="card-footer">
                    <p class="float-left">Итого</p>
                    <h4 class="float-right">{{baskets.total_sum|intcomma}} руб.</h4>
                </div>
            </div>
      <div id="checkout-button-wrapper">
    <a class="btn btn-success btn-lg float-right"
       href="{% url 'orders:order-create' %}"
       id="checkout-button"
       data-order-url="{% url 'orders:order-create' %}"
       data-catalog-url="{% url 'products:index' %}">
        Оформить заказ
    </a>
</div>


{%else%}
<h4 class="mt-3 mb-3 text-center">
                Корзина пуста
</h4>

{% endif %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.quantity-input').on('change', function() {
            let input = $(this);
            let basketId = input.data('id');
            let newQuantity = input.val();

            $.ajax({
                url: '{% url "products:basket_update" %}',
                method: 'POST',
                data: {
                    basket_id: basketId,
                    quantity: newQuantity,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    $('#basket-sum-' + basketId).text(response.item_sum + ' руб.');
                    $('.badge-pill').text(response.total_quantity);
                    $('.card-footer h4').text(response.total_sum + ' руб.');

                    if (response.total_quantity === 0) {
                        let button = $('#checkout-button');
                        button.removeClass('btn-success').addClass('btn-primary');
                        button.text('Добавить товары');
                        button.attr('href', button.data('catalog-url'));
                    } else {
                        let button = $('#checkout-button');
                        button.removeClass('btn-primary').addClass('btn-success');
                        button.text('Оформить заказ');
                        button.attr('href', button.data('order-url'));
                    }

                }
            });
        });
    });

    $('#checkout-button').on('click', function(e) {
    const button = $(this);
    const currentText = button.text().trim();

    if (currentText === 'Добавить товары') {
        e.preventDefault();

        $.ajax({
            url: '{% url "products:basket_clear_empty" %}',
            method: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            complete: function() {
                window.location.href = button.data('catalog-url');
            }
        });
    }
});


</script>

